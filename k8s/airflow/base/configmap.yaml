apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-config
data:
  AIRFLOW_HOME: /home/airflow
  # Executor
  AIRFLOW__CORE__EXECUTOR: KubernetesExecutor
  AIRFLOW__KUBERNETES_EXECUTOR__NAMESPACE: airflow
  AIRFLOW__KUBERNETES_EXECUTOR__POD_TEMPLATE_FILE: /home/airflow/pod_templates/pod_template.yaml
  # DAGs
  AIRFLOW__CORE__DAGS_FOLDER: /home/airflow/dags/repo/dags
  AIRFLOW__CORE__LOAD_EXAMPLES: "False"
  # Execution API (Airflow 3)
  AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://dev-airflow-webserver.airflow.svc.cluster.local:8080/execution/"
  # Logging
  AIRFLOW__CORE__BASE_LOG_FOLDER: /home/airflow/logs
  # Database (3.0: AIRFLOW__DATABASE__ replaces deprecated AIRFLOW__CORE__)
  AIRFLOW__DATABASE__LOAD_DEFAULT_CONNECTIONS: "False"
  # Webserver / API server
  AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "False"
  AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session"
  # Scheduler - keep dag processing inline (no separate dag-processor pod)
  AIRFLOW__SCHEDULER__STANDALONE_DAG_PROCESSOR: "False"
  AIRFLOW__DAG_PROCESSOR__REFRESH_INTERVAL: "30"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-pod-template
data:
  pod_template.yaml: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: airflow-task-pod
      namespace: airflow
    spec:
      serviceAccountName: dev-airflow
      restartPolicy: Never
      initContainers:
        - name: git-sync-init
          image: registry.k8s.io/git-sync/git-sync:v4.2.3
          args:
            - --repo=https://github.com/UtkarshChakrwarti/remote_airflow.git
            - --ref=main
            - --one-shot
            - --link=repo
            - --root=/git
          volumeMounts:
            - name: dags
              mountPath: /git
      containers:
        - name: airflow-task
          image: apache/airflow:3.0.0-python3.12
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: dev-airflow-config
            - secretRef:
                name: airflow-secret
          volumeMounts:
            - name: dags
              mountPath: /home/airflow/dags
            - name: airflow-logs
              mountPath: /home/airflow/logs
      volumes:
        - name: dags
          emptyDir: {}
        - name: airflow-logs
          persistentVolumeClaim:
            claimName: dev-logs-local-pvc
